= Ephemeral World Demo Scripts

This repository is for setup guides and scripts for my presentation on
Ephemeral environments using https://www.osbuild.org/[Image Builder] and https://buildah.io/[buildah].

This demo and talk leverage these operating systems

* https://fedoraproject.org[Fedora 35]
* https://redhat.com[Red Hat Enterprise Linux 8.x]
* https://redhat.com[Red Hat Enterprise Linux 9] *_Beta_*

In line with the talks focus on ephemeral environments we'll leverage cloud ready
images for the OS than can be rapidly configured via Ansible to demo the
key technologies.

== Deployment of Cloud / Virt ready OS Images

If you're running this demo code on a cloud hosted environment then simply select their pre-configured
cloud ready image, and skip to the setup of the demo tooling using Ansible below.

These instructions are for when you're running this locally under KVM + Libvirt.

Validated Images

* rhel-baseos-9.0-beta-0-x86_64-kvm.qcow2 
* rhel-8.5-x86_64-kvm.qcow2
* Fedora-Cloud-Base-35-1.2.x86_64.qcow2 

The process I'm using is I create a working snapshot off the working image and then 
customize the image to set a simple password for the root user. Ideally we should be using
the cloud-init capabilities to inject a valid user and credentials, but this is a quick
hack to speed up this demo deployment.

=== Deploy Fedora VM under KVM ===

[source,bash]
----
VM_NAME=Fedora35
VM_MEMORY=2048
VM_CPU=2
OS_VARIANT=fedora34
VM_BRIDGE=virbr1

VM_BASE=/opt/Virtual/ISO/Fedora-Cloud-Base-35-1.2.x86_64.qcow2
VM_IMAGE=/opt/Virtual/images/Fedora-35.qcow2

qemu-img create -f qcow2 -F qcow2 \
-o backing_file=${VM_BASE} ${VM_IMAGE}

virt-customize -a ${VM_IMAGE} \
-root-password password:password --uninstall cloud-init

# Then Create the VM

virt-install --name ${VM_NAME} --memory ${VM_MEMORY} --vcpus ${VM_CPU} \
    --disk path=$VM_IMAGE,format=qcow2,bus=scsi,discard=unmap \
    --os-variant=${OS_VARIANT} \
    --controller=type=scsi,model=virtio-scsi \
    --connect qemu:///system \
    --virt-type kvm \
    --noautoconsole \
    --import \
    --network type=bridge,source=${VM_BRIDGE} --graphics vnc

virsh console ${VM_NAME}

----

As SSH as root is disabled by default in Fedora 35 login intially via the virsh console and type

[source,bash]
----
echo "PermitRootLogin yes" > /etc/ssh/sshd_config.d/01-permitrootlogin.conf
systemctl restart sshd
----

I also recommend adding an entry in ~/.ssh/config with the correct IP address for your VM
which will simplify running the ansible playbook.

----
Host fedora35
Hostname 192.168.124.138
StrictHostKeyChecking no
UserKnownHostsFile /dev/null
User root
----

You should then enable login via your ssh-key so that Ansible can automate the rest of the setup


[source,bash]
----
ssh-copy-id fedora35
----

== Install / Configure buildah and Image Builder via Ansible

In the link:ansible[ansible] folder we've supplied a link:ansible/hosts.example[hosts.example]. Copy this to ansible/hosts
and customise based on the hostname of your buildah/ImageBuilder VM.

If you're running using a Red Hat Enterprise Linux based VM you'll need to make sure this is registered correctly
to pull packages from Red Hat's CDN service.  The ansible playbook with automate the registration providing you've got a valid secrets.yaml.
A sample link:ansible/secrets.yaml.example[secrets.yaml.example] has been provided which you'll need to update with a valid activation
key and organisation id.

You can then simply run the following to complete the setup of a demo environment.

[source,bash]
----
cd ansible
ansible-playbook -i hosts demo_setup.yaml
----



== Issues / Gotchas

=== Running out of space
The VM Images we're running are relatively small from a storage perspective so there is a chance
you'll run out of scratch space if you attempt to create very large images.


=== RHEL 9 Beta
At present the default install of RHEL 9 Beta attempts to use the production RHEL 9 content
repositories when building images. This issue is similar to the problem under.

* https://access.redhat.com/solutions/5773421

Currently the issue can be resolved by running the following on your RHEL9 VM

[source,bash]
----
mkdir -pv /etc/osbuild-composer/repositories

cp /usr/share/osbuild-composer/repositories/rhel-90.json /etc/osbuild-composer/repositories/rhel-90.json

cp -p /etc/osbuild-composer/repositories/rhel-90.json{,.bak}

sed -i -e 's|cdn.redhat.com/content/dist/rhel9|cdn.redhat.com/content/beta/rhel9|' \
/etc/osbuild-composer/repositories/rhel-90.json

systemctl restart osbuild-worker@.service.d osbuild-worker@1.service osbuild-composer.service
----


== Standards

All documentation will licenced under a http://creativecommons.org/licenses/by-sa/4.0/[Creative Commons Attribution-ShareAlike 4.0 International License],
whilst code, including Ansible playbooks, will be under a link:LICENSE[GPL v3 licence].

image::https://licensebuttons.net/l/by-sa/4.0/88x31.png[CC BY-SA-4.0 Logo]

All documentation will be treated like code and produced where possible in https://docs.asciidoctor.org/asciidoc/latest[AsciiDoc].
